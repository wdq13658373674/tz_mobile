<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>index</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no"/>

    <link rel="stylesheet" href="../../css/public.css">
    <link rel="stylesheet" href="../../css/mall.css">
    <link rel="stylesheet" href="../../js/addons/Swiper/swiper.min.css">

    <script type="text/javascript" src="../../js/fastclick.js"></script>
    <script type="text/javascript" src="../../js/public.js"></script>

    <title>商品详情页</title>
</head>
<body>
<header class="mall-header">
    <a href="#" class="icon-back-box">
        <i class="icon-back"></i>
    </a>
    <a class="cart-link-box" href="#">
        <i class="cart-link"></i>
    </a>
</header>
<header class="mall-header-sub">
    <a href="#" class="icon-back-box">
        <i class="icon-back"></i>
    </a>
    <a class="cart-link-box" href="#">
        <i class="cart-link"></i>
    </a>
</header>

<section>
    <div class="mall-banner">
        <div class="swiper-container">
            <div class="swiper-wrapper">
                <div class="swiper-slide">
                    <img src="../../images/img/test-img.png" alt="">
                </div>
                <div class="swiper-slide">
                    <img src="../../images/img/test-img.png" alt="">
                </div>
                <div class="swiper-slide">
                    <img src="../../images/img/test-img.png" alt="">
                </div>
            </div>
            <div class="swiper-pagination"></div>
        </div>
    </div>
    <div class="mall-goods-info">
        <div class="mall-goods-name">TYAKASHA塔卡沙TOYS SHOP系列女款米色羊羔绒彩色抽绳卫衣SOF26</div>
        <div class="mall-goods-price">
            <div class="mall-goods-rmb">
                ￥<span class="price">128.00</span>
            </div>
            <div class="mall-goods-tb">
                <i class="icon-tb"></i>
                <span class="price">55.00</span>
            </div>
        </div>
        <div class="mall-goods-other">
            <div class="expressage">快递：<span>0.00</span></div>
            <div class="soldNum">已售72件</div>
        </div>
    </div>

    <div class="row">
        <a class="mall-reel" href="#">领取优惠券<i class="icon-right"></i></a>
        <div class="mall-feature">
            <div class="feature-item"><i class="icon-dui-hole"></i><span>极速退货</span></div>
            <div class="feature-item"><i class="icon-dui-hole"></i><span>正品保证</span></div>
            <div class="feature-item"><i class="icon-dui-hole"></i><span>七天退换</span></div>
        </div>
    </div>

    <div class="row-w">
        <div class="cart-popup mall-size" id="size">
            <span class="sku-i" data-istrue="false">请选择<em></em></span>
            <i class="icon-right"></i>
        </div>
        <!--<div class="mall-argument">-->
        <!--<span>产品参数</span>-->
        <!--<i class="icon-right"></i>-->
        <!--</div>-->
    </div>

    <div class="evaluate">
        <div class="title-item">
            <hr class="line">
            <div class="title"><i class="icon-evaluate"></i>评价</div>
            <hr class="line">
        </div>
        <div class="content">
            <p class="btitle">宝贝评价(19)</p>
            <div class="evaluate-item">
                <p class="username">
                    <em class="user-img"><img src="" alt=""></em>
                    <span>b**o</span>
                </p>
                <p class="text">非常满意！！大热天吹着空调刚拿到就拆开试了！</p>
                <p class="type">颜色分类：如图色；尺码：S</p>
                <a class="evaluate-details" href="#">查看全部评价</a>
            </div>
        </div>
    </div>

    <div class="mall-details">
        <div class="title-item">
            <hr class="line">
            <div class="title"><i class="icon-img"></i>详情</div>
            <hr class="line">
        </div>
        <div class="content">
            <img src="../../images/img/test-img.png" alt="">
            <img src="../../images/img/test-img.png" alt="">
            <img src="../../images/img/test-img.png" alt="">
            <img src="../../images/img/test-img.png" alt="">
        </div>
    </div>
</section>

<footer class="mall-footer-box">
    <div class="mall-footer">
        <a class="func" href="#">
            <i class="icon icon-customer"></i>
            <p>客服</p>
        </a>
        <a class="func" href="#">
            <i class="icon icon-collect"></i>
            <p>收藏</p>
        </a>
        <a class="btn cart-popup" id="cart" href="#">加入购物车</a>
        <a class="btn join-cart cart-popup" id="buy" href="#">立即购买</a>
    </div>
</footer>

<div class="widgets-cover">
    <div class="cover-bg" aria-label="关闭弹层"></div>
    <div class="cover-content" role="dialog">
        <div class="sku-wrap">
            <div class="header">
                <div class="img-wrap">
                    <img src="../../images/img/test-img.png" class="j-summary-img" aria-label="选中的商品图">
                </div>
                <div class="main">
                    <div class="price-group">
                        <div class="price-rmb">
                            ￥<span class="rmb">128.00</span>
                        </div>
                        <div class="price-tb">
                            <i class="icon-tb"></i>
                            <span class="tb">55.00</span>
                        </div>
                    </div>
                    <div class="stock">库存 <span class="stockNum">10</span>件</div>
                    <div class="sku-info">
                        请选择
                    </div>
                </div>
            </div>
            <div class="body">
                <ul class="sku-list-wrap">
                    <li>
                        <h2 class="prop_sku_title">颜色</h2>
                        <div class="items" role="radiogroup">
                            <a role="radio" href="javascript:void(0)">G01浅灰花纱色 NEW LIGHT GREY MEKLANGE</a>
                            <a role="radio" href="javascript:void(0)">S01 黑色Black</a>
                            <a role="radio" href="javascript:void(0)">S02 新奶油色NEW CREME</a>
                        </div>
                    </li>
                    <li>
                        <h2 class="prop_sku_title">尺码</h2>
                        <div class="items" role="radiogroup">
                            <a role="radio" href="javascript:void(0)">155/76A/XS</a>
                            <a role="radio" href="javascript:void(0)">160/80A/S</a>
                            <a role="radio" href="javascript:void(0)">165/84A/M</a>
                            <a role="radio" href="javascript:void(0)">170/88A/L</a>
                        </div>
                    </li>
                </ul>

                <div class="number-wrap">
                    <div class="number-line">
                        <label for="number">购买数量</label>
                        <div class="number">
                            <button class="decrease disabled">-</button>
                            <input id="number" type="number" value="1">
                            <button class="increase">+</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="footer trade">
                <a class="btn cart show" role="button">加入购物车</a>
                <a class="btn confirm hide" role="button">确定</a>
                <a class="btn buy show" role="button">立即购买</a>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="../../js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="../../js/addons/Swiper/swiper.min.js"></script>

<script>
    var product = {};

    var products = {
        'types': ['color', 'size'],
        'color': {
            'id1': {
                'size': [],
                'text': '白色'
            },
            'id2': {
                'size': [],
                'text': '黑色'
            },
            'id3': {
                'size': [],
                'text': '蓝色'
            },
            'id4': {
                'size': [],
                'text': '灰色'
            },
            'text': '颜色',
        },
        'size': {
            'id1': {
                'text': '155/76A/XS',
                'color': []
            },
            'id2': {
                'text': '160/80A/S',
                'color': [],
            },
            'id3': {
                'text': '165/84A/M',
                'color': [],
            },
            'id4': {
                'text': '170/88A/L',
                'color': [],
            },
            'text': '尺码'
        }
    };

    function init(products, el) {
        var guige = products.types;
        var html = '';
        for (var index in guige) {
            var type = guige[index];
            var types = getTypes(type);
            if (!inArray('text', types)) {
                throw '没有找到对应的文本';
            }
            html += genHtml(products[type], type);
        }
        document.querySelector(el).innerHTML = html;

        bindEvent('.sku-list-wrap a');

        // 注册事件
        function getTypes(index) {
            return Object.keys(products[index]);
        }
    }

    init(products, '.sku-list-wrap');

    function genHtml(product, type) {
        if (product.hasOwnProperty('text')) {
            var a = '';
            for (key in product) {
                if (key != 'text') {
                    a += '<a role="radio" href="javascript:void(0)" data-id="' + key + '">' + product[key].text + '</a>';
                }
            }
            return [
                '<li class="', type, '">',
                '    <h2 class="prop_sku_title">', product.text, '</h2>',
                '    <div class="items" role="radiogroup">',
                a,
                '     </div>',
                '</li>'
            ].join("");
        } else {
            return '';
        }
    }

    function inArray(key, data) {
        for (var index in data) {
            if (data[index] == key) {
                return true;
            }
        }
        return false;
    }

    function bindEvent(el) {
        var element = el || '.sku-list-wrap';
        $(element).off('click').on('click', function () {
            var self = $(this),
                types = products.types,
                type = self.parents('li').attr('class'),
                id = self.attr('data-id');
            if (inArray(type, types)) {
                if (self.hasClass('checked')) {
                    // 同时删除掉producu的属性.
                    delete product[type];
//                    product[type] = undefined;
                    self.removeClass('checked');
                } else {
                    // 这里添加.
                    product[type] = {
                        'id': id,
                        'text': products[type][id].text,
                        'class': type
                    };
                    self.addClass('checked').siblings().removeClass('checked');
                }
                display(product, types);
            }
        });

        function display(product, types) {
            var spans = '';
            if (isEmpty(product)) {
                spans = '请选择';
                for (var index in types) {
                    spans += products[types[index]].text + ' ';
                }
                $(".sku-i").attr("data-istrue", "false");
            } else {
                for (var index in product) {
                    spans += '<span class="' + product[index].class + '">' + product[index].text + '</span>';
                }
                $(".sku-i").attr("data-istrue", "true");
            }
            $('.sku-info').html(spans);
            $(".sku-i").html(spans);
        }

        function isEmpty(product) {
            for (var index in product) {
                return false;
            }
            return true;
        }
    }
</script>
<script>
    (function (products) {
        $(window).scroll(function () {
            /*顶部效果*/
            var bheight = $(".mall-banner").height();
            var sheight = $(document).scrollTop();
            var bp = Number((sheight / bheight).toFixed(2));
            var xp = 1 - bp;
            if (bp >= 1) {
                bp = 1;
            }
            if (xp <= 0) {
                xp = 0;
            }
            $(".mall-header").css("opacity", xp);
            $(".mall-header-sub").css("opacity", bp);
        });
        /*焦点图*/
        var swiper = new Swiper('.swiper-container', {
            width: window.innerWidth,
            height: window.innerHeight,
            loop: true,
            pagination: '.swiper-pagination'
        });

        /*弹窗*/
        $(".cart-popup").on("click", function () {
            /*弹窗效果*/
            $(".widgets-cover").addClass("show");
            $("html").css({"overflow": "hidden"});
            $(".cover-bg").on("click", function () {
                $(".widgets-cover").removeClass("show");
                $("html").css({"overflow": "auto"});
            });
        });


        /*测试数据*/
        var a = {
            '50': {
                count: 1,
                productId: "50",
                productName: "辣条",
                productParam: {
                    type: "spec",
                    spec_id: "16",
                    id: 31,
                    name: "50g"
                },
                productPrice: 50,
                productStock: -1
            },
            '56': {
                count: 56,
                productId: "50",
                productName: "辣条",
                productParam: {
                    type: "spec",
                    spec_id: "16_17",
                    id: 31,
                    name: "50g,60g"
                },
                productPrice: 50,
                productStock: -1
            }
        };
        var pId = 50;
        var buy_goods = {"count": 1, "productId": "", "productName": "", "productPrice": 0, "productStock": 0};

        localStorage.setItem("mall_goods", JSON.stringify(a));
        //localStorage.clear();
        var mall_goods = JSON.parse(localStorage.getItem("mall_goods"));

        //console.log(inArray(pId,Object.keys(mall_goods)));
        function goods_parameter(pId) {
            var goods_name = $(".mall-goods-name").text();
            var imgurl = $(".swiper-container img").eq(0).attr("src");
            var price = Number($(".rmb").text());
            var isChecked = $(".checked"), spec_id = '', name = '';
            var kcnum = Number($(".stockNum").text());
            var pnum = $("#number");
            if (inArray(pId, Object.keys(mall_goods))) {
                /*当前商品已存在*/
                /*商品ID*/
                buy_goods.productId = pId;
                /*商品名称*/
                buy_goods.productName = goods_name;
                /*商品图片*/
                buy_goods.img_url = imgurl;
                /*商品价格*/
                buy_goods.productPrice = price;
                mall_goods[pId].count += Number(pnum.val());

            } else {
                /*当前商品未存在*/
                /*商品ID*/
                buy_goods.productId = pId;
                /*商品名称*/
                buy_goods.productName = goods_name;
                /*商品图片*/
                buy_goods.img_url = imgurl;
                /*商品价格*/
                buy_goods.productPrice = price;
            }

            /*商品属性*/
            if (isChecked !== "") {
                for (var i = 0; i < isChecked.length; i++) {
                    spec_id += "_" + $(isChecked[i]).data("id");
                    name += "," + $(isChecked[i]).text();
                }
                spec_id = spec_id.substr(1);
                name = name.substr(1);
                var productParam = {type: "spec", id: 31};
                productParam.spec_id = spec_id;
                productParam.name = name;
                buy_goods.productParam = productParam;
            } else {
                throw Error;
            }
        }

        /*商品数量*/
        var goodsnum = Number($("#number").val());
        var stock = Number($(".stockNum").text());
        $(".number .decrease").on("click", function () {
            if (goodsnum <= 1) {
                goodsnum = 1;
                $(this).addClass("disabled").attr({"disabled": "disabled"});
            } else {
                $(".increase").removeAttr("disabled").removeClass("disabled");
                $(this).removeAttr("disabled").removeClass("disabled");
                goodsnum--;
            }
            buy_goods.count = goodsnum;
            $("#number").val(goodsnum);
        });

        $(".number .increase").on("click", function () {
            if (goodsnum >= stock) {
                goodsnum = stock;
                $(this).addClass("disabled").attr({"disabled": "disabled"});
            } else {
                $(".decrease").removeAttr("disabled").removeClass("disabled");
                $(this).removeAttr("disabled").removeClass("disabled");
                goodsnum++;

            }
            buy_goods.count = goodsnum;
            $("#number").val(goodsnum);
        });

        $("#buy").on("click", function () {
            var sku_i = $(".sku-i").attr("data-istrue");
            if (sku_i === "true") {
                $(".trade .confirm").show();
                $(".trade .cart").hide();
                $(".trade .buy").hide();
            } else {
                $(".trade .confirm").hide();
                $(".trade .cart").show();
                $(".trade .buy").show();
            }
        });
        $("#cart").on("click", function () {
            var sku_i = $(".sku-i").attr("data-istrue");
            if (sku_i === "true") {
                $(".trade .confirm").show();
                $(".trade .cart").hide();
                $(".trade .buy").hide();
            } else {
                $(".trade .confirm").hide();
                $(".trade .cart").show();
                $(".trade .buy").show();
            }
        });
        $("#size").on("click", function () {
            $(".trade .confirm").hide();
            $(".trade .cart").show();
            $(".trade .buy").show();
        });

        $(".cart").on("click", function () {
            goods_parameter(pId);
            if (buy_goods.productParam.name === "" || $(".checked").length !== $(".sku-list-wrap li").length) {
                message("请选择规格参数！");
            } else {
                mall_goods[pId] = buy_goods;
                //console.log(mall_goods);
                localStorage.setItem("mall_goods", JSON.stringify(mall_goods));
            }
        });
        $(".buy").on("click", function () {
            goods_parameter(pId);
            if (buy_goods.productParam.name === "" || $(".checked").length !== $(".sku-list-wrap li").length) {
                message("请选择规格参数！");
            } else {
                mall_goods[pId] = buy_goods;
                localStorage.setItem("mall_goods", JSON.stringify(buy_goods));
            }
        })

    })();
</script>
</body>
</html>